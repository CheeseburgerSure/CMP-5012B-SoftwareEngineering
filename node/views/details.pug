doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Change Details | ParkFlow
    link(rel="stylesheet" href="styles.css")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css")

  body
    // Navbar
    nav.navbar
      .logo ParkFlow
      .menu-icon(onclick="toggleMenu()") &#9776;
      ul.nav-links
        li: a(href="/dashboard") Dashboard
        li: a(href="/logout") Logout

    // Main content
    .content
      .form-container
        h1 Change Your Details

        .details-box
          // User ID
          .detail-row
            label User ID:
            if user && user.id
              span #{user.id}
            else
              span No ID available

          // Email
          .detail-row
            label Email:
            if user && user.email
              span #{user.email}
            else
              span No email available
            a.btn-change(href="javascript:void(0);", onclick="toggleField('email')") Change
            
            // Editable email form
            .edit-field#email-field(style="display: none;")
              input(type="email" id="new-email" value=(user && user.email) ? user.email : '')
              button(type="button" onclick="saveChanges('email')") Save

          // First Name
          .detail-row
            label First Name:
            if user && user.first_name
              span #{user.first_name}
            else
              span No first name available
            a.btn-change(href="javascript:void(0);", onclick="toggleField('first-name')") Change
            .edit-field#first-name-field(style="display: none;")
              input(type="text" id="new-first-name" value=(user && user.first_name) ? user.first_name : '')
              button(type="button" onclick="saveChanges('first-name')") Save

          // Last Name
          .detail-row
            label Last Name:
            if user && user.last_name
              span #{user.last_name}
            else
              span No last name available
            a.btn-change(href="javascript:void(0);", onclick="toggleField('last-name')") Change
            .edit-field#last-name-field(style="display: none;")
              input(type="text" id="new-last-name" value=(user && user.last_name) ? user.last_name : '')
              button(type="button" onclick="saveChanges('last-name')") Save

          // Password
          .detail-row
            label Password:
            span ••••••••
            a.btn-change(href="javascript:void(0);", onclick="toggleField('password')") Change
            .edit-field#password-field(style="display: none;")
              input(type="password" id="current-password" placeholder="Enter current password")
              input(type="password" id="new-password" placeholder="Enter new password")
              input(type="password" id="confirm-password" placeholder="Confirm new password")
              button(type="button" onclick="saveChanges('password')") Save

    // Footer
    footer
      p &copy; 2025 ParkFlow. All Rights Reserved.

    script.
      function toggleField(field) {
        const fieldId = field + '-field';
        const fieldElement = document.getElementById(fieldId);
        const allFields = document.querySelectorAll('.edit-field');
        allFields.forEach(f => f.style.display = 'none');
        fieldElement.style.display = 'block';
      }

      async function saveChanges(field) {
        const body = {};

        if (field === 'first-name') {
          body.first_name = document.getElementById('new-first-name').value;
        } else if (field === 'last-name') {
          body.last_name = document.getElementById('new-last-name').value;
        } else if (field === 'email') {
          body.email = document.getElementById('new-email').value;
        } else if (field === 'password') {
          const current = document.getElementById('current-password').value;
          const newPass = document.getElementById('new-password').value;
          const confirm = document.getElementById('confirm-password').value;

          if (!current || !newPass || !confirm) {
            alert('Please fill out all password fields.');
            return;
          }

          if (newPass !== confirm) {
            alert('New password and confirmation do not match.');
            return;
          }

          body.current_password = current;
          body.new_password = newPass;
        }

        try {
          const response = await fetch('/details/change-details', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
          });

          const result = await response.json();
          if (response.ok) {
            alert('Successfully updated!');
            location.reload();
          } else {
            alert(result.error || 'Failed to update. Please try again.');
          }
        } catch (error) {
          console.error('Error updating details:', error);
          alert('An error occurred. Please try again later.');
        }
      }
